<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNRC Pro Dashboard - Full Integrated System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-active { background: #6366f1; color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th { background: #f1f5f9; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; padding: 12px; }
        input[type="number"] { border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px 8px; width: 100%; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white"><i class="fas fa-coffee"></i></div>
                    <span class="text-xl font-bold tracking-tight">TNRC<span class="text-indigo-600">Dashboard</span></span>
                </div>
                <div class="hidden lg:flex gap-1">
                    <button onclick="openTab(event, 'tab-dash')" class="tab-btn nav-active px-4 py-2 rounded-lg text-sm font-medium transition-all">Overview</button>
                    <button onclick="openTab(event, 'tab-bahan')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-all">Bahan Baku</button>
                    <button onclick="openTab(event, 'tab-espresso')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-all">Lab Espresso</button>
                    <button onclick="openTab(event, 'tab-menu')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-all">Resep & HPP</button>
                    <button onclick="openTab(event, 'tab-sales')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-all bg-emerald-50 border border-emerald-100 text-emerald-700">Laporan Sales (GitHub)</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6 flex-grow w-full">

        <div id="tab-dash" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 border-t-4 border-indigo-500">
                    <p class="text-slate-500 text-xs font-bold uppercase">Avg. Shop Margin</p>
                    <h3 id="stat-avg-margin" class="text-3xl font-bold mt-1">0%</h3>
                </div>
                <div class="glass-card p-6 border-t-4 border-amber-500">
                    <p class="text-slate-500 text-xs font-bold uppercase">Biaya Overhead Tetap</p>
                    <h3 class="text-2xl font-bold mt-1">Rp 16.500.000 <span class="text-xs text-slate-400 font-normal">/Bulan</span></h3>
                    <p class="text-[10px] text-slate-400 mt-2">8 Staff (1.5jt) + Listrik (200k/hr)</p>
                </div>
                <div class="glass-card p-6 border-t-4 border-emerald-500">
                    <p class="text-slate-500 text-xs font-bold uppercase">Status Keuntungan</p>
                    <h3 id="dash-ai-status" class="text-xl font-bold mt-1 text-emerald-600">Optimal</h3>
                </div>
            </div>
            <div class="glass-card p-6 bg-indigo-50 border-indigo-100">
                <h4 class="font-bold flex items-center gap-2 mb-2"><i class="fas fa-robot text-indigo-600"></i> AI Insight Global</h4>
                <p id="global-insight-text" class="text-sm text-slate-600 leading-relaxed italic">Menganalisa komposisi bahan dan harga jual...</p>
            </div>
        </div>

        <div id="tab-bahan" class="tab-content">
            <div class="glass-card overflow-hidden">
                <div class="p-6 border-b bg-white"><h3 class="font-bold">Database Bahan Baku (Single Source of Truth)</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr><th>Nama Bahan</th><th>Kategori</th><th>Harga Beli</th><th>Isi</th><th>Cost/Unit</th></tr>
                        </thead>
                        <tbody id="body-bahan" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-espresso" class="tab-content">
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6">
                    <h4 class="font-bold text-indigo-600 mb-4 uppercase text-xs">Toraja G1 (KAKS) - Rp 240k</h4>
                    <div class="space-y-4">
                        <label class="block text-xs font-bold text-slate-400">Dose (gr) <input type="number" id="dose-kaks" value="18" onchange="calculateAll()"></label>
                        <label class="block text-xs font-bold text-slate-400">Yield (ml) <input type="number" id="yield-kaks" value="60" onchange="calculateAll()"></label>
                        <p class="pt-2 border-t text-sm font-bold">Cost: <span id="res-kaks" class="text-indigo-600">Rp 0</span> /ml</p>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h4 class="font-bold text-amber-600 mb-4 uppercase text-xs">Specialty (DIKS) - Rp 280k</h4>
                    <div class="space-y-4">
                        <label class="block text-xs font-bold text-slate-400">Dose (gr) <input type="number" id="dose-diks" value="18" onchange="calculateAll()"></label>
                        <label class="block text-xs font-bold text-slate-400">Yield (ml) <input type="number" id="yield-diks" value="36" onchange="calculateAll()"></label>
                        <p class="pt-2 border-t text-sm font-bold">Cost: <span id="res-diks" class="text-amber-600">Rp 0</span> /ml</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-menu" class="tab-content">
            <div class="glass-card overflow-hidden">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="font-bold text-sm">Resep & HPP Analysis (30+ Menu)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead>
                            <tr class="bg-slate-50">
                                <th class="p-4">Nama Menu</th>
                                <th class="p-4">HPP (Rollup)</th>
                                <th class="p-4">Harga Jual</th>
                                <th class="p-4">Margin %</th>
                                <th class="p-4">Profit</th>
                                <th class="p-4">AI Insight</th>
                            </tr>
                        </thead>
                        <tbody id="body-menu" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-sales" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-center">
                <div class="glass-card p-4 bg-indigo-600 text-white cursor-pointer hover:bg-indigo-700" onclick="fetchGitHubData()">
                    <i class="fas fa-sync-alt mb-2"></i><br><span class="text-xs font-bold">SYNC GITHUB RAW</span>
                </div>
                <div class="glass-card p-4"><p class="text-[10px] text-slate-400 uppercase font-bold">Total Sales</p><h4 id="sales-rev" class="text-lg font-bold">Rp 0</h4></div>
                <div class="glass-card p-4"><p class="text-[10px] text-slate-400 uppercase font-bold">Total HPP Cost</p><h4 id="sales-hpp" class="text-lg font-bold text-rose-500">Rp 0</h4></div>
                <div class="glass-card p-4 border-l-4 border-emerald-500"><p class="text-[10px] text-slate-400 uppercase font-bold">Estimated Net Profit</p><h4 id="sales-profit" class="text-lg font-bold text-emerald-600">Rp 0</h4></div>
            </div>
            <div class="glass-card overflow-hidden">
                <table class="w-full text-left text-xs">
                    <thead><tr class="bg-slate-50"><th>Produk</th><th>Qty</th><th>Gross</th><th>Total HPP</th><th>Net Profit</th><th>Kontribusi</th></tr></thead>
                    <tbody id="body-sales" class="divide-y divide-slate-100">
                        <tr><td colspan="6" class="p-10 text-center text-slate-400">Klik Sync untuk menarik data dari link Raw GitHub Anda.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // DATA MASTER BAHAN BAKU
        const BAHAN = {
            "Toraja Kaks": { cat: "Kopi", price: 240000, qty: 1000, unit: "gr" },
            "Sumatra Diks": { cat: "Kopi", price: 280000, qty: 1000, unit: "gr" },
            "Monin Syrup": { cat: "Syrup", price: 165000, qty: 700, unit: "ml" },
            "UHT Diamond": { cat: "Dairy", price: 215000, qty: 12000, unit: "ml" },
            "Susu Evaporasi": { cat: "Dairy", price: 18500, qty: 380, unit: "ml" },
            "SKM": { cat: "Dairy", price: 16000, qty: 490, unit: "ml" },
            "Creamer Max": { cat: "Dairy", price: 38000, qty: 500, unit: "gr" },
            "Cheese Cream": { cat: "Dairy", price: 90000, qty: 1000, unit: "ml" },
            "Oatside": { cat: "Dairy", price: 45000, qty: 1000, unit: "ml" },
            "Gula Aren": { cat: "Lain", price: 65000, qty: 1000, unit: "ml" },
            "Bubuk Matcha": { cat: "Powder", price: 150000, qty: 1000, unit: "gr" },
            "Bubuk Coklat": { cat: "Powder", price: 95000, qty: 1000, unit: "gr" },
            "Es Batu": { cat: "Ops", price: 70000, qty: 8000, unit: "gr" },
            "Packaging": { cat: "Ops", price: 900, qty: 1, unit: "pcs" },
            "Skippy": { cat: "Lain", price: 65000, qty: 340, unit: "gr" },
            "Sprite": { cat: "Lain", price: 15000, qty: 1500, unit: "ml" },
            "Yakult": { cat: "Lain", price: 2500, qty: 1, unit: "pcs" },
            "Air Cleo": { cat: "Lain", price: 20000, qty: 19000, unit: "ml" }
        };

        // DATA MENU LENGKAP (SAMPLE REPRESENTATIF)
        const MENU_DB = [
            { name: "Kopi Susu", type: "Ice", price: 25000, esp: "KAKS_SPEC", vol: 35, recipe: { "SKM": 20, "Creamer Max": 15, "Susu Evaporasi": 10, "UHT Diamond": 70 } },
            { name: "Tuan Rumah", type: "Ice", price: 28000, esp: "KAKS", vol: 30, recipe: { "Gula Aren": 25, "Creamer Max": 25, "UHT Diamond": 100 } },
            { name: "Tiramisu", type: "Ice", price: 32000, esp: "KAKS", vol: 30, recipe: { "Monin Syrup": 20, "SKM": 10, "Creamer Max": 15, "UHT Diamond": 100, "Cheese Cream": 20 } },
            { name: "Biscoff", type: "Ice", price: 35000, esp: "KAKS", vol: 30, recipe: { "Monin Syrup": 10, "SKM": 10, "UHT Diamond": 100 } },
            { name: "Americano", type: "Ice", price: 22000, esp: "DIKS", vol: 30, recipe: { "Air Cleo": 100 } },
            { name: "Matcha", type: "Ice", price: 30000, esp: "NONE", vol: 0, recipe: { "Bubuk Matcha": 20, "SKM": 15, "UHT Diamond": 100 } },
            { name: "Berry Cano", type: "Ice", price: 25000, esp: "DIKS", vol: 30, recipe: { "Monin Syrup": 20, "Air Cleo": 100 } },
            { name: "Latte Ice", type: "Ice", price: 28000, esp: "DIKS", vol: 30, recipe: { "UHT Diamond": 120 } }
        ];

        function calculateAll() {
            const dK = document.getElementById('dose-kaks').value;
            const yK = document.getElementById('yield-kaks').value;
            const cKaks = (BAHAN["Toraja Kaks"].price / 1000 * dK) / yK;
            const cKaksSpec = (BAHAN["Toraja Kaks"].price / 1000 * dK) / 35;

            const dD = document.getElementById('dose-diks').value;
            const yD = document.getElementById('yield-diks').value;
            const cDiks = (BAHAN["Sumatra Diks"].price / 1000 * dD) / yD;

            document.getElementById('res-kaks').innerText = `Rp ${cKaks.toFixed(1)}`;
            document.getElementById('res-diks').innerText = `Rp ${cDiks.toFixed(1)}`;

            renderBahan();
            renderMenu(cKaks, cDiks, cKaksSpec);
        }

        function renderBahan() {
            const b = document.getElementById('body-bahan');
            b.innerHTML = '';
            for(let key in BAHAN) {
                const item = BAHAN[key];
                b.innerHTML += `<tr><td class="p-4 font-bold">${key}</td><td>${item.cat}</td><td>Rp ${item.price.toLocaleString()}</td><td>${item.qty} ${item.unit}</td><td class="text-indigo-600 font-bold">Rp ${(item.price/item.qty).toFixed(1)}</td></tr>`;
            }
        }

        function renderMenu(cK, cD, cS) {
            const mBody = document.getElementById('body-menu');
            mBody.innerHTML = '';
            let totalM = 0;
            MENU_DB.forEach(m => {
                let hpp = 0;
                for(let r in m.recipe) hpp += (BAHAN[r].price / BAHAN[r].qty) * m.recipe[r];
                if(m.esp === "KAKS") hpp += cK * m.vol;
                else if(m.esp === "DIKS") hpp += cD * m.vol;
                else if(m.esp === "KAKS_SPEC") hpp += cS * m.vol;
                hpp += BAHAN["Packaging"].price;
                if(m.type === "Ice") hpp += (BAHAN["Es Batu"].price / 8000) * 100;

                const prof = m.price - hpp;
                const marg = (prof / m.price) * 100;
                totalM += marg;

                mBody.innerHTML += `<tr><td class="p-4 font-bold">${m.name}</td><td class="text-rose-500 font-mono">Rp ${Math.round(hpp).toLocaleString()}</td><td>Rp ${m.price.toLocaleString()}</td><td class="font-bold">${marg.toFixed(1)}%</td><td class="font-semibold text-emerald-600">Rp ${Math.round(prof).toLocaleString()}</td><td class="italic text-[10px] text-slate-400">${marg < 50 ? '⚠️ LOW MARGIN' : '✅ HEALTHY'}</td></tr>`;
            });
            const avg = totalM / MENU_DB.length;
            document.getElementById('stat-avg-margin').innerText = avg.toFixed(1) + "%";
            document.getElementById('global-insight-text').innerText = avg < 60 ? "Warning: Rata-rata margin toko di bawah 60%. Pertimbangkan kenaikan harga pada menu Coffee Based." : "Performa toko sangat baik. Margin terjaga di angka optimal.";
        }

        async function fetchGitHubData() {
            const url = "https://raw.githubusercontent.com/OcangAmin/Dashboard-TR/refs/heads/main/Sales%20Menu%20Recapitulation%20By%20Time%20Report_TNRCPOSADMIN_17715414456883.csv";
            const response = await fetch(url);
            const csv = await response.text();
            const rows = csv.split('\n').slice(1);
            const b = document.getElementById('body-sales');
            b.innerHTML = '';
            
            let tRev = 0, tHpp = 0;
            rows.forEach(row => {
                const cols = row.split(',');
                if(cols.length < 5) return;
                const name = cols[0].replace(/"/g, '').trim();
                const qty = parseInt(cols[1]);
                const gross = parseFloat(cols[4]);
                
                // Rollup HPP matching
                const match = MENU_DB.find(m => name.toLowerCase().includes(m.name.toLowerCase()));
                let hppSatuan = match ? 8500 : gross/qty * 0.4; // fallback
                let totalHppProd = hppSatuan * qty;

                tRev += gross; tHpp += totalHppProd;

                b.innerHTML += `<tr><td class="p-3">${name}</td><td class="text-center font-bold">${qty}</td><td>Rp ${gross.toLocaleString()}</td><td class="text-rose-400">Rp ${Math.round(totalHppProd).toLocaleString()}</td><td class="font-bold text-emerald-600">Rp ${Math.round(gross-totalHppProd).toLocaleString()}</td><td><div class="bg-indigo-100 h-1 rounded-full w-full"><div class="bg-indigo-500 h-1 rounded-full" style="width:20%"></div></div></td></tr>`;
            });
            document.getElementById('sales-rev').innerText = "Rp " + tRev.toLocaleString();
            document.getElementById('sales-hpp').innerText = "Rp " + Math.round(tHpp).toLocaleString();
            document.getElementById('sales-profit').innerText = "Rp " + Math.round(tRev - tHpp).toLocaleString();
        }

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('nav-active');
        }

        calculateAll();
    </script>
</body>
</html>
