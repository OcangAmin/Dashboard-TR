<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Advanced Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .filter-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; margin-bottom: 20px; }
        .stat-box { padding: 15px; background: #e7f3ff; border-radius: 8px; color: #007bff; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #007bff; color: white; position: sticky; top: 0; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: left; font-size: 13px; }
        .scroll-table { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="card">
    <h2>ðŸ“Š Filter Penjualan Interaktif</h2>
    
    <div class="filter-group">
        <div>
            <label>Cari Menu:</label>
            <input type="text" id="searchMenu" placeholder="Ketik nama menu..." oninput="applyFilters()">
        </div>
        <div>
            <label>Tanggal Mulai:</label>
            <input type="date" id="startDate" onchange="applyFilters()">
        </div>
        <div>
            <label>Tanggal Selesai:</label>
            <input type="date" id="endDate" onchange="applyFilters()">
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-box">Total Transaksi: <span id="statCount">0</span></div>
        <div class="stat-box">Total Qty: <span id="statQty">0</span></div>
        <div class="stat-box">Total Pendapatan: <span id="statRevenue">0</span></div>
    </div>

    <canvas id="mainChart" height="100"></canvas>
</div>

<div class="card">
    <h3>Data Detail (Terfilter)</h3>
    <div class="scroll-table">
        <table id="dataTable">
            <thead><tr id="tableHeader"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let masterData = []; // Menyimpan semua data asli
    let chartInstance = null;
    const url = 'https://raw.githubusercontent.com/OcangAmin/Dashboard-TR/refs/heads/main/Sales%20Menu%20Recapitulation%20By%20Time%20Report_TNRCPOSADMIN_17715414456883.csv';

    // 1. Load Data Otomatis saat halaman dibuka
    window.onload = () => {
        Papa.parse(url, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: function(results) {
                masterData = results.data;
                initTableHeader(masterData[0]);
                applyFilters(); // Jalankan filter pertama kali
            }
        });
    };

    function initTableHeader(firstRow) {
        const header = document.getElementById('tableHeader');
        Object.keys(firstRow).forEach(key => {
            header.innerHTML += `<th>${key}</th>`;
        });
    }

    // 2. Logika Filter Utama
    function applyFilters() {
        const searchTerm = document.getElementById('searchMenu').value.toLowerCase();
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        const filtered = masterData.filter(row => {
            // Filter Teks
            const matchText = row.Menu?.toString().toLowerCase().includes(searchTerm);
            
            // Filter Tanggal (Asumsi kolom bernama 'Date')
            let matchDate = true;
            if (start && row.Date) matchDate = matchDate && (row.Date >= start);
            if (end && row.Date) matchDate = matchDate && (row.Date <= end);

            return matchText && matchDate;
        });

        updateUI(filtered);
    }

    // 3. Update Tampilan (Chart & Table)
    function updateUI(data) {
        // Update Statistik
        document.getElementById('statCount').innerText = data.length.toLocaleString();
        const totalQty = data.reduce((sum, row) => sum + (Number(row.Qty) || 0), 0);
        document.getElementById('statQty').innerText = totalQty.toLocaleString();
        
        // Update Tabel (Hanya tampilkan 100 pertama untuk kecepatan)
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.slice(0, 100).forEach(row => {
            let tr = '<tr>';
            Object.values(row).forEach(val => tr += `<td>${val ?? ''}</td>`);
            tbody.innerHTML += tr + '</tr>';
        });

        // Update Chart (Top 5 Menu)
        renderChart(data);
    }

    function renderChart(data) {
        const counts = {};
        data.forEach(row => { counts[row.Menu] = (counts[row.Menu] || 0) + (Number(row.Total) || 0); });
        
        const sortedLabels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
        const sortedValues = sortedLabels.map(l => counts[l]);

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('mainChart'), {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{ label: 'Total Penjualan', data: sortedValues, backgroundColor: '#007bff' }]
            },
            options: { indexAxis: 'y' } // Horizontal bar agar teks menu terbaca
        });
    }
</script>
</body>
</html>
